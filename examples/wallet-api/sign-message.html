<!DOCTYPE html>
<html>
    <head>
        <title>My cool dapp</title>
        <script src="/sdk.js"></script>
        <script src="/helpers.js"></script>
        <script src="https://unpkg.com/cbor-web"></script>
        <meta charset="utf-8" />
        <script>
            let currentAccountAddress = '';

            async function setupPage() {
                const provider = await concordiumHelpers.detectConcordiumProvider();
                provider.on('accountDisconnected', (accountAddress) => (currentAccountAddress = undefined));
                provider.on('accountChanged', (accountAddress) => (currentAccountAddress = accountAddress));
                provider.on('chainChanged', (chain) => alert(chain));

                document.getElementById('connect').addEventListener('click', () => {
                    provider.connect().then((accountAddress) => {
                        currentAccountAddress = accountAddress;
                        document.getElementById('accountAddress').innerHTML = accountAddress;
                    });
                });

                document.getElementById('requestAccounts').addEventListener('click', () => {
                    provider.requestAccounts().then((accountAddresses) => {
                        currentAccountAddress = accountAddresses[0];
                        document.getElementById('accountAddress').innerHTML = accountAddresses;
                    });
                });

                document.getElementById('signMessage').addEventListener('click', () =>
                    provider
                        .signMessage(currentAccountAddress, message.value)
                        .then((sig) => alert(JSON.stringify(sig)))
                        .catch(alert)
                );

                document.getElementById('signMessageBinary').addEventListener('click', () => {
                    const SERIALIZATION_HELPER_SCHEMA =
                        'FAAFAAAAEAAAAGNvbnRyYWN0X2FkZHJlc3MMCwAAAGVudHJ5X3BvaW50FgEFAAAAbm9uY2UFCQAAAHRpbWVzdGFtcA0HAAAAcGF5bG9hZBUCAAAACAAAAFRyYW5zZmVyAQEAAAAQARQABQAAAAgAAAB0b2tlbl9pZB0ABgAAAGFtb3VudBslAAAABAAAAGZyb20VAgAAAAcAAABBY2NvdW50AQEAAAALCAAAAENvbnRyYWN0AQEAAAAMAgAAAHRvFQIAAAAHAAAAQWNjb3VudAEBAAAACwgAAABDb250cmFjdAECAAAADBYBBAAAAGRhdGEdAQ4AAABVcGRhdGVPcGVyYXRvcgEBAAAAEAEUAAIAAAAGAAAAdXBkYXRlFQIAAAAGAAAAUmVtb3ZlAgMAAABBZGQCCAAAAG9wZXJhdG9yFQIAAAAHAAAAQWNjb3VudAEBAAAACwgAAABDb250cmFjdAEBAAAADA';
                    const sponsoredMessage = {
                        contract_address: {
                            index: 0,
                            subindex: 0,
                        },
                        entry_point: 'contract_transfer',
                        nonce: 1,
                        payload: {
                            Transfer: [
                                [
                                    {
                                        amount: '1',
                                        data: '',
                                        from: {
                                            Account: [currentAccountAddress],
                                        },
                                        to: {
                                            Account: [currentAccountAddress],
                                        },
                                        token_id: '11111111',
                                    },
                                ],
                            ],
                        },
                        timestamp: '2030-08-08T05:15:00Z',
                    };
                    const serializedMessage = concordiumSDK.serializeTypeValue(
                        sponsoredMessage,
                        concordiumSDK.toBuffer(SERIALIZATION_HELPER_SCHEMA, 'base64')
                    );
                    provider
                        .signMessage(currentAccountAddress, {
                            data: concordiumSDK.Parameter.toHexString(serializedMessage),
                            schema: SERIALIZATION_HELPER_SCHEMA,
                        })
                        .then((sig) => alert(JSON.stringify(sig)))
                        .catch(alert);
                });
            }
            setupPage();
        </script>
    </head>

    <body>
        <div>
            <button id="connect">Connect</button>
            <h3 id="accountAddress" style="display: inline">Account address:</h3>
        </div>
        <br />
        <button id="requestAccounts">Request accounts</button>
        Message: <input type="text" id="message" value="I believe in miracles" />
        <button id="signMessage">SignMessage</button>
        <button id="signMessageBinary">SignSponsoredTransactionLikeMessage</button>
    </body>
</html>
