<!DOCTYPE html>
<html>
    <head>
        <title>My cool dapp</title>
        <script src="/sdk.js"></script>
        <script src="/helpers.js"></script>
        <script src="https://unpkg.com/cbor-web"></script>
        <meta charset="utf-8" />
        <script>
            let currentAccountAddress = '';

            async function setupPage() {
                const provider = await concordiumHelpers.detectConcordiumProvider();
                provider.on('accountDisconnected', (accountAddress) => (currentAccountAddress = undefined));
                provider.on('accountChanged', (accountAddress) => (currentAccountAddress = accountAddress));
                provider.on('chainChanged', (chain) => alert(chain));

                document.getElementById('connect').addEventListener('click', () => {
                    provider.connect().then((accountAddress) => {
                        currentAccountAddress = accountAddress;
                        document.getElementById('accountAddress').innerHTML = accountAddress;
                    });
                });

                document.getElementById('requestAccounts').addEventListener('click', () => {
                    provider.requestAccounts().then((accountAddresses) => {
                        currentAccountAddress = accountAddresses[0];
                        document.getElementById('accountAddress').innerHTML = accountAddresses;
                    });
                });

                document.getElementById('idProof').addEventListener('click', () => {
                    const statement = new concordiumSDK.IdStatementBuilder()
                        .revealAttribute(0)
                        .revealAttribute(1)
                        .revealAttribute(2)
                        .addMinimumAge(18)
                        .addEUResidency()
                        .getStatement();
                    const challenge = 'AAAAAAAA';
                    provider
                        .requestIdProof(currentAccountAddress, statement, challenge)
                        .then((proof) => {
                            console.log(proof);
                            alert('Proof received! (check the console)');
                        })
                        .catch(alert);
                });

                document.getElementById('web3Proof').addEventListener('click', () => {
                    const statement = new concordiumSDK.Web3StatementBuilder()
                        .addForIdentityCredentials([0, 1, 2], (b) =>
                            b.revealAttribute('firstName').addRange('dob', '08000101', '20000101')
                        )
                        .addForVerifiableCredentials([{ index: 5463, subindex: 0 }], (b) =>
                            b.revealAttribute('degreeName').addMembership('graduationDate', ['2010-06-01T00:00:00Z'])
                        )
                        .getStatements();
                    const challenge = '94d3e85bbc8ff0091e562ad8ef6c30d57f29b19f17c98ce155df2a30100dAAAA';
                    provider
                        .requestVerifiablePresentation(challenge, statement)
                        .then((proof) => {
                            console.log(proof);
                            alert('Proof received! (check the console)');
                        })
                        .catch((error) => {
                            console.log(error);
                            alert(error);
                        });
                });

                document.getElementById('ageProof').addEventListener('click', () => {
                    // TODO Replace add range with addMinimumAge(18) when SDK is fixed.
                    const statement = new concordiumSDK.Web3StatementBuilder()
                        .addForIdentityCredentials([0, 1, 2, 3, 4, 5], (b) =>
                            b.addRange('dob', concordiumSDK.MIN_DATE, concordiumSDK.getPastDate(18, 1))
                        )
                        .getStatements();
                    const challenge = 'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA';
                    provider
                        .requestVerifiablePresentation(challenge, statement)
                        .then((proof) => {
                            console.log(proof);
                            alert('Proof received! (check the console)');
                        })
                        .catch(alert);
                });
            }
            setupPage();
        </script>
    </head>

    <body>
        <div>
            <button id="connect">Connect</button>
            <h3 id="accountAddress" style="display: inline">Account address:</h3>
        </div>
        <br />
        <button id="requestAccounts">Request accounts</button>
        <button id="idProof">Request an ID Proof</button>
        <button id="web3Proof">Request an ID 3 Proof</button>
        <button id="ageProof">Request an Age Proof</button>
    </body>
</html>
